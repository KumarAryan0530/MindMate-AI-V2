{% extends 'base.html' %}
{% load static %}

{% block title %}AI Story Adventure - MindMate{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-800 to-pink-900 py-12 px-4">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-pink-400 mb-3">
        üìñ AI Story Adventure
      </h1>
      <p class="text-gray-200 text-lg">
        <span class="inline-block bg-pink-600 px-3 py-1 rounded-full text-sm font-semibold mr-2">AI POWERED</span>
        Your choices shape the narrative ‚Ä¢ <span class="font-bold text-yellow-300">{{ genre|title }}</span> Genre
      </p>
    </div>

    <!-- Progress Bar -->
    <div class="bg-gray-800 bg-opacity-60 backdrop-blur-sm rounded-xl shadow-2xl p-4 mb-6 border border-pink-500">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="bg-gradient-to-br from-purple-900 to-purple-700 rounded-lg p-3">
          <div class="text-2xl font-bold text-purple-300" id="chapter-number">Ch. 1</div>
          <div class="text-xs text-gray-300 mt-1">üìö Chapter</div>
        </div>
        <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-lg p-3">
          <div class="text-2xl font-bold text-blue-300" id="choices-count">0</div>
          <div class="text-xs text-gray-300 mt-1">üéØ Choices Made</div>
        </div>
        <div class="bg-gradient-to-br from-green-900 to-green-700 rounded-lg p-3">
          <div class="text-2xl font-bold text-green-300" id="timer">00:00</div>
          <div class="text-xs text-gray-300 mt-1">‚è±Ô∏è Time</div>
        </div>
        <div class="bg-gradient-to-br from-yellow-900 to-yellow-700 rounded-lg p-3">
          <div class="text-2xl font-bold text-yellow-300" id="score-preview">0</div>
          <div class="text-xs text-gray-300 mt-1">‚≠ê Score</div>
        </div>
      </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="bg-gray-800 bg-opacity-80 backdrop-blur-md rounded-2xl shadow-2xl p-12 text-center border border-pink-500">
      <div class="animate-spin text-6xl mb-4">üìö</div>
      <h2 class="text-2xl font-bold text-white mb-4">AI is crafting your adventure...</h2>
      <p class="text-gray-300">Generating the opening chapter...</p>
      <div class="mt-6 w-full bg-gray-700 rounded-full h-3 overflow-hidden">
        <div class="bg-gradient-to-r from-pink-500 to-purple-500 h-3 rounded-full animate-pulse" style="width: 60%"></div>
      </div>
    </div>

    <!-- Story Container -->
    <div id="story-container" class="hidden">
      <!-- Story Display -->
      <div class="bg-gray-800 bg-opacity-80 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-6 border border-purple-500">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-yellow-300">
              <span id="story-chapter-title">Chapter 1: The Beginning</span>
            </h2>
            <div class="text-sm text-gray-400" id="chapter-indicator">Chapter 1</div>
          </div>
          
          <div class="prose prose-invert max-w-none">
            <div id="story-text" class="text-gray-100 text-lg leading-relaxed whitespace-pre-wrap">
              <!-- Story content will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Situation Summary -->
        <div id="situation-box" class="mt-6 p-4 bg-indigo-900 bg-opacity-50 border-l-4 border-indigo-400 rounded">
          <p class="text-sm text-indigo-200">
            <span class="font-bold">Current Situation:</span>
            <span id="situation-text">...</span>
          </p>
        </div>
      </div>

      <!-- Choices Section -->
      <div id="choices-section" class="space-y-4 mb-6">
        <h3 class="text-2xl font-bold text-center text-pink-300 mb-4">üí≠ What do you do?</h3>
        <div id="choices-container" class="space-y-3">
          <!-- Choice buttons will be inserted here -->
        </div>
      </div>

      <!-- AI Thinking Indicator -->
      <div id="thinking-indicator" class="hidden bg-purple-900 bg-opacity-50 backdrop-blur-md rounded-xl p-6 text-center border border-purple-500">
        <div class="animate-pulse">
          <div class="text-4xl mb-3">ü§ñ</div>
          <p class="text-purple-200 font-medium">AI is weaving the next chapter...</p>
          <div class="mt-4 flex justify-center space-x-2">
            <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        </div>
      </div>

      <!-- Story History (Collapsible) -->
      <div class="mt-6">
        <button 
          onclick="toggleHistory()"
          class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg transition flex items-center justify-between"
        >
          <span>üìú View Story History</span>
          <span id="history-arrow">‚ñº</span>
        </button>
        <div id="story-history" class="hidden mt-3 bg-gray-800 bg-opacity-60 rounded-lg p-6 max-h-96 overflow-y-auto">
          <div id="history-content" class="space-y-4">
            <!-- History items will be added here -->
          </div>
        </div>
      </div>

      <!-- Back Button -->
      <div class="text-center mt-6">
        <a href="{% url 'games:mini_games_home' %}" class="inline-block bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition">
          ‚Üê Back to Mini Games
        </a>
      </div>
    </div>

    <!-- Ending Modal -->
    <div id="ending-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
      <div class="bg-gradient-to-br from-gray-900 to-purple-900 rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4 transform transition-all border-2 border-yellow-500 max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
          <div class="text-7xl mb-4" id="ending-emoji">üé≠</div>
          <h2 class="text-4xl font-bold mb-3 text-yellow-400" id="ending-title">The End</h2>
          <p class="text-xl text-gray-300 mb-2" id="ending-type">A Tale Concluded</p>
        </div>
        
        <div class="bg-gray-800 bg-opacity-50 rounded-xl p-6 mb-6">
          <h3 class="text-xl font-bold text-pink-400 mb-3">üìñ Your Story's Conclusion:</h3>
          <p class="text-gray-200 leading-relaxed mb-4" id="ending-description">...</p>
        </div>

        <div class="text-center mb-6">
          <div class="text-6xl font-extrabold mb-2">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500" id="final-score">0</span>
          </div>
          <p class="text-gray-400 text-sm">Final Score</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-purple-900 bg-opacity-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-300" id="final-chapters">0</div>
            <div class="text-xs text-gray-400 mt-1">Chapters</div>
          </div>
          <div class="bg-blue-900 bg-opacity-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-300" id="final-choices">0</div>
            <div class="text-xs text-gray-400 mt-1">Choices</div>
          </div>
          <div class="bg-green-900 bg-opacity-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-300" id="final-time">00:00</div>
            <div class="text-xs text-gray-400 mt-1">Time</div>
          </div>
          <div class="bg-yellow-900 bg-opacity-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-300" id="final-ending">-</div>
            <div class="text-xs text-gray-400 mt-1">Ending</div>
          </div>
        </div>

        <div class="flex gap-4">
          <button id="new-story-btn" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
            üìö New Adventure
          </button>
          <a href="{% url 'games:mini_games_home' %}" class="flex-1 text-center bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition">
            ‚Üê Back to Games
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const genre = "{{ genre }}";
  let currentChapter = 1;
  let choicesMade = 0;
  let seconds = 0;
  let timerInterval = null;
  let storyHistory = [];

  // Genre emojis
  const genreEmojis = {
    'fantasy': '‚öîÔ∏è',
    'scifi': 'üöÄ',
    'mystery': 'üîç',
    'horror': 'üëª',
    'adventure': 'üó∫Ô∏è'
  };

  // Ending emojis
  const endingEmojis = {
    'victory': 'üéâ',
    'twist': 'üé≠',
    'bittersweet': 'üòå',
    'tragedy': 'üò¢',
    'neutral': 'üìñ'
  };

  // Start timer
  function startTimer() {
    if (!timerInterval) {
      timerInterval = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('timer').textContent = 
          `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        updateScorePreview();
      }, 1000);
    }
  }

  // Update score preview
  function updateScorePreview() {
    const baseScore = 100;
    const chapterBonus = currentChapter * 50;
    const engagementBonus = Math.min(choicesMade * 20, 100);
    const score = baseScore + chapterBonus + engagementBonus;
    document.getElementById('score-preview').textContent = score;
  }

  // Toggle history
  function toggleHistory() {
    const history = document.getElementById('story-history');
    const arrow = document.getElementById('history-arrow');
    if (history.classList.contains('hidden')) {
      history.classList.remove('hidden');
      arrow.textContent = '‚ñ≤';
    } else {
      history.classList.add('hidden');
      arrow.textContent = '‚ñº';
    }
  }

  // Add to history
  function addToHistory(chapter, text, choice = null) {
    const historyContent = document.getElementById('history-content');
    const item = document.createElement('div');
    item.className = 'border-l-4 border-purple-500 pl-4 py-2';
    item.innerHTML = `
      <div class="text-sm font-bold text-purple-400">Chapter ${chapter}</div>
      <div class="text-gray-300 text-sm mt-1">${text.substring(0, 150)}${text.length > 150 ? '...' : ''}</div>
      ${choice ? `<div class="text-xs text-pink-400 mt-2">‚Üí You chose: ${choice}</div>` : ''}
    `;
    historyContent.appendChild(item);
  }

  // Load story
  async function loadStory() {
    try {
      const response = await fetch("{% url 'games:start_story' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ genre: genre })
      });

      const data = await response.json();
      
      if (data.success) {
        // Display story
        displayStory(data.story.opening, data.story.situation, data.story.choices);
        addToHistory(1, data.story.opening);
        
        // Show story, hide loading
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('story-container').classList.remove('hidden');
        
        // Start timer
        startTimer();
      } else {
        alert('Failed to load story: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error loading story:', error);
      alert('Failed to load story. Please try again.');
    }
  }

  // Display story
  function displayStory(text, situation, choices) {
    document.getElementById('story-text').textContent = text;
    document.getElementById('situation-text').textContent = situation;
    
    // Update chapter title
    document.getElementById('story-chapter-title').textContent = 
      `Chapter ${currentChapter}: ${genreEmojis[genre] || 'üìñ'} The Adventure Continues`;
    
    // Display choices
    const choicesContainer = document.getElementById('choices-container');
    choicesContainer.innerHTML = '';
    
    choices.forEach((choice, index) => {
      const button = document.createElement('button');
      button.className = 'w-full bg-gradient-to-r from-purple-700 to-pink-700 hover:from-purple-800 hover:to-pink-800 text-white font-medium py-4 px-6 rounded-xl shadow-lg transition transform hover:scale-105 text-left';
      button.innerHTML = `
        <div class="flex items-start">
          <div class="text-2xl mr-3">${['üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÖ≤Ô∏è'][index]}</div>
          <div>
            <div class="font-bold mb-1">${choice.text}</div>
            <div class="text-xs text-pink-200">${choice.type || 'action'}</div>
          </div>
        </div>
      `;
      button.onclick = () => makeChoice(choice.id, choice.text);
      choicesContainer.appendChild(button);
    });
  }

  // Make choice
  async function makeChoice(choiceId, choiceText) {
    // Hide choices, show thinking
    document.getElementById('choices-section').classList.add('hidden');
    document.getElementById('thinking-indicator').classList.remove('hidden');
    
    choicesMade++;
    document.getElementById('choices-count').textContent = choicesMade;
    
    try {
      const response = await fetch("{% url 'games:continue_story' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ 
          choice_id: choiceId,
          choice_text: choiceText
        })
      });

      const data = await response.json();
      
      if (data.success) {
        currentChapter = data.chapter;
        document.getElementById('chapter-number').textContent = `Ch. ${currentChapter}`;
        document.getElementById('chapter-indicator').textContent = `Chapter ${currentChapter}`;
        
        // Add previous choice to history
        addToHistory(currentChapter - 1, document.getElementById('story-text').textContent, choiceText);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
          document.getElementById('thinking-indicator').classList.add('hidden');
          
          if (data.is_ending && data.continuation.ending) {
            // Show ending
            showEnding(data.continuation);
          } else {
            // Continue story
            displayStory(data.continuation.narrative, data.continuation.situation, data.continuation.choices);
            document.getElementById('choices-section').classList.remove('hidden');
          }
        }, 1500);
      } else {
        alert(data.error || 'Failed to continue story.');
        document.getElementById('thinking-indicator').classList.add('hidden');
        document.getElementById('choices-section').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error making choice:', error);
      alert('Failed to continue story. Please try again.');
      document.getElementById('thinking-indicator').classList.add('hidden');
      document.getElementById('choices-section').classList.remove('hidden');
    }
  }

  // Show ending
  async function showEnding(continuation) {
    // Stop timer
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    
    const ending = continuation.ending;
    const endingType = ending.type || 'neutral';
    
    // Display final narrative
    document.getElementById('story-text').textContent = continuation.narrative;
    document.getElementById('situation-text').textContent = 'The story concludes...';
    
    // Save score
    try {
      const response = await fetch("{% url 'games:end_story' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ ending_type: endingType })
      });

      const data = await response.json();
      
      if (data.success) {
        // Show ending modal
        document.getElementById('ending-emoji').textContent = endingEmojis[endingType] || 'üìñ';
        document.getElementById('ending-title').textContent = ending.title || 'The End';
        document.getElementById('ending-type').textContent = endingType.charAt(0).toUpperCase() + endingType.slice(1) + ' Ending';
        document.getElementById('ending-description').textContent = ending.description || continuation.narrative;
        document.getElementById('final-score').textContent = data.score;
        document.getElementById('final-chapters').textContent = data.stats.chapters;
        document.getElementById('final-choices').textContent = data.stats.choices;
        
        const mins = Math.floor(data.stats.time / 60);
        const secs = data.stats.time % 60;
        document.getElementById('final-time').textContent = 
          `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('final-ending').textContent = endingType;
        
        setTimeout(() => {
          document.getElementById('ending-modal').classList.remove('hidden');
        }, 1000);
      }
    } catch (error) {
      console.error('Error ending story:', error);
    }
  }

  // New story
  document.getElementById('new-story-btn').addEventListener('click', () => {
    window.location.reload();
  });

  // Initialize
  loadStory();
</script>
{% endblock %}
