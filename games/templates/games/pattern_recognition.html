{% extends 'base.html' %}
{% load static %}

{% block title %}Pattern Recognition - MindMate{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 py-12 px-4">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">üéØ Pattern Recognition</h1>
      <p class="text-gray-600">Watch the pattern and repeat it! Difficulty: <span class="font-bold text-indigo-600">{{ difficulty|title }}</span></p>
    </div>

    <!-- Game Stats -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
        <div class="bg-indigo-50 rounded-lg p-4">
          <div class="text-3xl font-bold text-indigo-600" id="level">1</div>
          <div class="text-sm text-gray-600 mt-1">Level</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4">
          <div class="text-3xl font-bold text-green-600" id="streak">0</div>
          <div class="text-sm text-gray-600 mt-1">Streak</div>
        </div>
        <div class="bg-purple-50 rounded-lg p-4">
          <div class="text-3xl font-bold text-purple-600" id="lives">3</div>
          <div class="text-sm text-gray-600 mt-1">Lives</div>
        </div>
        <div class="bg-yellow-50 rounded-lg p-4">
          <div class="text-3xl font-bold text-yellow-600" id="score">0</div>
          <div class="text-sm text-gray-600 mt-1">Score</div>
        </div>
      </div>
    </div>

    <!-- Game Status -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 text-center">
      <div id="game-message" class="text-2xl font-bold text-gray-700">
        Ready? Click START to begin!
      </div>
    </div>

    <!-- Color Buttons Grid -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
      <div class="grid grid-cols-2 gap-6 max-w-md mx-auto">
        <!-- Red Button -->
        <button id="btn-0" class="color-btn h-40 rounded-xl shadow-lg transform transition duration-150 active:scale-95" 
                style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"
                data-sound="261.63">
        </button>
        
        <!-- Blue Button -->
        <button id="btn-1" class="color-btn h-40 rounded-xl shadow-lg transform transition duration-150 active:scale-95" 
                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"
                data-sound="329.63">
        </button>
        
        <!-- Green Button -->
        <button id="btn-2" class="color-btn h-40 rounded-xl shadow-lg transform transition duration-150 active:scale-95" 
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"
                data-sound="392.00">
        </button>
        
        <!-- Yellow Button -->
        <button id="btn-3" class="color-btn h-40 rounded-xl shadow-lg transform transition duration-150 active:scale-95" 
                style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
                data-sound="523.25">
        </button>
      </div>
    </div>

    <!-- AI Hint Section -->
    <div id="ai-hint-section" class="hidden bg-gradient-to-r from-indigo-50 to-purple-50 border-l-4 border-indigo-500 p-4 rounded mb-6">
      <div class="flex items-start">
        <div class="text-2xl mr-3">ü§ñ</div>
        <div>
          <p class="font-medium text-indigo-800 mb-2">AI Coach Hint:</p>
          <p class="text-indigo-700" id="ai-hint-text"></p>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="text-center space-x-4 flex flex-wrap justify-center gap-4">
      <button id="start-btn" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
        üöÄ Start Game
      </button>
      <button id="ai-hint-btn" class="hidden bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
        ü§ñ AI Hint
      </button>
      <button id="restart-btn" class="hidden bg-gradient-to-r from-pink-600 to-red-600 hover:from-pink-700 hover:to-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
        üîÑ Try Again
      </button>
      <a href="{% url 'games:mini_games_home' %}" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
        ‚Üê Back to Games
      </a>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div id="gameover-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 transform transition-all">
    <div class="text-center">
      <div class="text-6xl mb-4">üéÆ</div>
      <h2 class="text-3xl font-bold text-gray-800 mb-4">Game Over!</h2>
      <p class="text-gray-600 mb-6">You've completed the game!</p>
      
      <div class="space-y-3 mb-6 text-left">
        <div class="flex justify-between items-center bg-indigo-50 rounded-lg p-3">
          <span class="font-medium text-gray-700">Level Reached:</span>
          <span class="font-bold text-indigo-600" id="final-level">1</span>
        </div>
        <div class="flex justify-between items-center bg-green-50 rounded-lg p-3">
          <span class="font-medium text-gray-700">Best Streak:</span>
          <span class="font-bold text-green-600" id="final-streak">0</span>
        </div>
        <div class="flex justify-between items-center bg-purple-50 rounded-lg p-3">
          <span class="font-medium text-gray-700">Final Score:</span>
          <span class="font-bold text-purple-600" id="final-score">0</span>
        </div>
      </div>

      <div class="space-y-3">
        <button id="play-again-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
          üéÆ Play Again
        </button>
        <a href="{% url 'games:mini_games_home' %}" class="block w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105 text-center">
          ‚Üê Back to Games
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .color-btn {
    border: none;
    cursor: pointer;
    opacity: 0.8;
  }

  .color-btn:hover {
    opacity: 0.9;
  }

  .color-btn.active {
    opacity: 1;
    filter: brightness(1.3);
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
  }

  .color-btn:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
</style>

<script>
  const difficulty = "{{ difficulty }}";
  const difficultySettings = {
    'easy': { startSpeed: 800, minSpeed: 600, speedDecrease: 20 },
    'medium': { startSpeed: 600, minSpeed: 400, speedDecrease: 30 },
    'hard': { startSpeed: 400, minSpeed: 200, speedDecrease: 40 }
  };
  
  const settings = difficultySettings[difficulty];
  
  let sequence = [];
  let playerSequence = [];
  let level = 1;
  let streak = 0;
  let bestStreak = 0;
  let lives = 3;
  let score = 0;
  let playing = false;
  let playbackSpeed = settings.startSpeed;
  let audioContext = null;

  const buttons = document.querySelectorAll('.color-btn');
  const startBtn = document.getElementById('start-btn');
  const restartBtn = document.getElementById('restart-btn');
  const gameMessage = document.getElementById('game-message');

  // Web Audio API for sounds
  function initAudio() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  // Play tone for button
  function playTone(frequency, duration = 300) {
    initAudio();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration / 1000);
  }

  // Flash button
  function flashButton(index, duration = playbackSpeed / 2) {
    const btn = document.getElementById(`btn-${index}`);
    const frequency = parseFloat(btn.dataset.sound);
    
    btn.classList.add('active');
    playTone(frequency, duration);
    
    setTimeout(() => {
      btn.classList.remove('active');
    }, duration);
  }

  // Disable buttons
  function disableButtons() {
    buttons.forEach(btn => btn.disabled = true);
  }

  // Enable buttons
  function enableButtons() {
    buttons.forEach(btn => btn.disabled = false);
  }

  // Play sequence
  async function playSequence() {
    disableButtons();
    gameMessage.textContent = 'Watch the pattern...';
    
    for (let i = 0; i < sequence.length; i++) {
      await new Promise(resolve => setTimeout(resolve, playbackSpeed));
      flashButton(sequence[i]);
    }
    
    await new Promise(resolve => setTimeout(resolve, playbackSpeed));
    gameMessage.textContent = 'Your turn! Repeat the pattern.';
    playerSequence = [];
    enableButtons();
  }

  // Start new round
  function nextRound() {
    level++;
    streak++;
    bestStreak = Math.max(bestStreak, streak);
    playbackSpeed = Math.max(settings.minSpeed, settings.startSpeed - (level * settings.speedDecrease));
    
    updateUI();
    
    // Add new color to sequence
    const randomColor = Math.floor(Math.random() * 4);
    sequence.push(randomColor);
    
    setTimeout(playSequence, 1000);
  }

  // Check player move
  function checkMove(index) {
    if (!playing) return;
    
    flashButton(index, 200);
    playerSequence.push(index);
    
    // Check if current move is correct
    const currentIndex = playerSequence.length - 1;
    if (playerSequence[currentIndex] !== sequence[currentIndex]) {
      // Wrong move!
      lives--;
      streak = 0;
      
      if (lives <= 0) {
        gameOver();
      } else {
        disableButtons();
        gameMessage.textContent = `Wrong! ${lives} ${lives === 1 ? 'life' : 'lives'} remaining. Try this level again...`;
        updateUI();
        
        setTimeout(() => {
          playerSequence = [];
          playSequence();
        }, 2000);
      }
      return;
    }
    
    // Check if sequence completed
    if (playerSequence.length === sequence.length) {
      // Success!
      disableButtons();
      score += level * 100;
      gameMessage.textContent = '‚úÖ Perfect! Get ready for next level...';
      updateUI();
      
      setTimeout(nextRound, 1500);
    }
  }

  // Update UI
  function updateUI() {
    document.getElementById('level').textContent = level;
    document.getElementById('streak').textContent = streak;
    document.getElementById('lives').textContent = lives;
    document.getElementById('score').textContent = score;
  }

  // Start game
  function startGame() {
    sequence = [];
    playerSequence = [];
    level = 1;
    streak = 0;
    bestStreak = 0;
    lives = 3;
    score = 0;
    playing = true;
    playbackSpeed = settings.startSpeed;
    
    updateUI();
    
    startBtn.classList.add('hidden');
    restartBtn.classList.remove('hidden');
    
    // Start first round
    const randomColor = Math.floor(Math.random() * 4);
    sequence.push(randomColor);
    
    setTimeout(playSequence, 1000);
  }

  // Game over
  function gameOver() {
    playing = false;
    disableButtons();
    gameMessage.textContent = 'Game Over! Out of lives.';
    
    document.getElementById('final-level').textContent = level;
    document.getElementById('final-streak').textContent = bestStreak;
    document.getElementById('final-score').textContent = score;
    document.getElementById('gameover-modal').classList.remove('hidden');
    
    // Save score
    saveScore();
  }

  // Save score via AJAX
  function saveScore() {
    fetch("{% url 'games:save_minigame_score' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        game_type: 'pattern_recognition',
        difficulty: difficulty,
        score: score,
        time_taken: 0,
        moves_count: level,
        completed: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Score saved successfully!');
      }
    })
    .catch(error => console.error('Error saving score:', error));
  }

  // Event listeners
  startBtn.addEventListener('click', () => {
    startGame();
    document.getElementById('ai-hint-btn').classList.remove('hidden');
  });
  
  restartBtn.addEventListener('click', () => {
    startGame();
    document.getElementById('ai-hint-btn').classList.remove('hidden');
  });
  
  buttons.forEach((btn, index) => {
    btn.addEventListener('click', () => checkMove(index));
  });

  document.getElementById('play-again-btn').addEventListener('click', () => {
    document.getElementById('gameover-modal').classList.add('hidden');
    startGame();
    document.getElementById('ai-hint-btn').classList.remove('hidden');
  });

  // AI Hint functionality
  document.getElementById('ai-hint-btn').addEventListener('click', async () => {
    const hintBtn = document.getElementById('ai-hint-btn');
    const hintSection = document.getElementById('ai-hint-section');
    const hintText = document.getElementById('ai-hint-text');
    
    hintBtn.disabled = true;
    hintBtn.textContent = 'ü§ñ Getting hint...';
    
    try {
      const response = await fetch("{% url 'games:get_ai_hint' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          game_type: 'pattern_recognition',
          difficulty: difficulty,
          current_state: {
            level: level,
            lives: lives,
            streak: streak
          }
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        hintText.textContent = data.hint;
        hintSection.classList.remove('hidden');
        setTimeout(() => hintSection.classList.add('hidden'), 10000);
      }
    } catch (error) {
      console.error('Error fetching AI hint:', error);
      hintText.textContent = 'Focus on the rhythm and create mental associations with each color!';
      hintSection.classList.remove('hidden');
    }
    
    hintBtn.disabled = false;
    hintBtn.textContent = 'ü§ñ AI Hint';
  });

  // Initialize
  disableButtons();
</script>
{% endblock %}
